# Example Data Files for dgeo Migration

This directory contains example data files showing the expected formats for the dgeo migration workflow.

## File Formats

### 1. Metadata JSON (for TransformModule)

**File**: `landsat_assets_edited_metadata.json`

This file maps item IDs to their dgeo metadata. Generated by `extract_assets_for_dgeo.py convert`.

```json
{
  "LC08_L1TP_001001_20210101_20210101_02_T1": {
    "id": "LC08_L1TP_001001_20210101_20210101_02_T1",
    "collection_id": "landsat-c2l1",
    "ipfs_cids": [
      "bafybeigdyrzt5sfp7udm7hu76uh7y26nf3efuylqabf3oclgtqy55fbzdi",
      "bafybeic2zycyt36xnkbvbzqbrmhb3jndcylvqywb4zfqn7i6kcsjjl62ka"
    ],
    "filecoin_piece_cids": [
      "baga6ea4seaqao7s73y24kcutaosvacpdjgfe5pw76ooefnyqw4ynr3d2y6x2mpq"
    ]
  },
  "LC08_L1TP_001002_20210101_20210101_02_T1": {
    "id": "LC08_L1TP_001002_20210101_20210101_02_T1",
    "collection_id": "landsat-c2l1",
    "ipfs_cids": [
      "bafybeihdwdcefgh4dfdiu3uqzumz5sxbjwckvfoziwc35f5ql9lmhzxm6a"
    ],
    "filecoin_piece_cids": [
      "baga6ea4seaqjwxzqxhj7f5j4j5z7k5p5w7x8y9zabcdefghijklmnopqrstuv"
    ]
  }
}
```

**Usage in workflow**:
```yaml
- id: enrich_with_metadata
  module: TransformModule
  config:
    input_file: "./data/landsat_assets_edited_metadata.json"
    input_join_key: "id"
    field_mapping:
      dgeo:cids: "ipfs_cids"
      dgeo:piece_cids: "filecoin_piece_cids"
```

---

### 2. Asset CIDs JSON (for UpdateModule patch_file)

**File**: `landsat_assets_edited_asset_cids.json`

This file maps specific assets to their individual CIDs. Generated by `extract_assets_for_dgeo.py convert`.

```json
{
  "LC08_L1TP_001001_20210101_20210101_02_T1": {
    "assets": {
      "red": {
        "dgeo:cid": "bafybeigdyrzt5sfp7udm7hu76uh7y26nf3efuylqabf3oclgtqy55fbzdi"
      },
      "nir": {
        "dgeo:cid": "bafybeic2zycyt36xnkbvbzqbrmhb3jndcylvqywb4zfqn7i6kcsjjl62ka"
      },
      "blue": {
        "dgeo:cid": "bafybeifoobar123456789abcdefghijklmnopqrstuvwxyz"
      }
    }
  },
  "LC08_L1TP_001002_20210101_20210101_02_T1": {
    "assets": {
      "red": {
        "dgeo:cid": "bafybeihdwdcefgh4dfdiu3uqzumz5sxbjwckvfoziwc35f5ql9lmhzxm6a"
      },
      "nir": {
        "dgeo:cid": "bafybeianotherexample7890abcdefghijk"
      }
    }
  }
}
```

**Usage in workflow**:
```yaml
- id: set_asset_cids
  module: UpdateModule
  config:
    patch_file: "./data/landsat_assets_edited_asset_cids.json"
    mode: "merge"
```

---

### 3. Full Data JSON (for reference)

**File**: `landsat_assets_edited_full.json`

This file contains all extracted data in one place. Use for debugging or custom processing.

```json
{
  "LC08_L1TP_001001_20210101_20210101_02_T1": {
    "item_id": "LC08_L1TP_001001_20210101_20210101_02_T1",
    "collection_id": "landsat-c2l1",
    "assets": {
      "red": {
        "item_id": "LC08_L1TP_001001_20210101_20210101_02_T1",
        "collection_id": "landsat-c2l1",
        "asset_key": "red",
        "asset_type": "main",
        "href": "https://example.com/red.tif",
        "title": "Red Band",
        "media_type": "image/tiff; application=geotiff",
        "roles": "data",
        "description": "Red band (0.64-0.67 µm)",
        "s3_href": "s3://landsat-pds/c2/l1/001/001/2021/01/01/red.tif",
        "s3_name": "S3",
        "ipfs_href": "ipfs://bafybeigdyrzt5sfp7udm7hu76uh7y26nf3efuylqabf3oclgtqy55fbzdi",
        "ipfs_cid": "bafybeigdyrzt5sfp7udm7hu76uh7y26nf3efuylqabf3oclgtqy55fbzdi",
        "filecoin_href": "",
        "filecoin_piece_cid": ""
      },
      "nir": {
        "item_id": "LC08_L1TP_001001_20210101_20210101_02_T1",
        "collection_id": "landsat-c2l1",
        "asset_key": "nir",
        "asset_type": "main",
        "href": "https://example.com/nir.tif",
        "title": "Near Infrared Band",
        "media_type": "image/tiff; application=geotiff",
        "roles": "data",
        "description": "NIR band (0.85-0.88 µm)",
        "s3_href": "s3://landsat-pds/c2/l1/001/001/2021/01/01/nir.tif",
        "s3_name": "S3",
        "ipfs_href": "ipfs://bafybeic2zycyt36xnkbvbzqbrmhb3jndcylvqywb4zfqn7i6kcsjjl62ka",
        "ipfs_cid": "bafybeic2zycyt36xnkbvbzqbrmhb3jndcylvqywb4zfqn7i6kcsjjl62ka",
        "filecoin_href": "filecoin://baga6ea4seaqao7s73y24kcutaosvacpdjgfe5pw76ooefnyqw4ynr3d2y6x2mpq",
        "filecoin_piece_cid": "baga6ea4seaqao7s73y24kcutaosvacpdjgfe5pw76ooefnyqw4ynr3d2y6x2mpq"
      }
    }
  }
}
```

---

### 4. Custom CID Profiles (optional)

**File**: `custom_cid_profiles.json`

Use this if you need to override the default CID profiles for specific assets.

```json
{
  "LC08_L1TP_001001_20210101_20210101_02_T1": {
    "assets": {
      "red": {
        "dgeo:cid_profile": {
          "cid_version": 1,
          "chunk_algorithm": "rabin",
          "chunk_size": 131072,
          "dag_layout": "trickle",
          "hash_function": "blake3"
        }
      }
    }
  }
}
```

**Usage in workflow**:
```yaml
- id: set_custom_profiles
  module: UpdateModule
  depends_on: [set_asset_cids]
  config:
    patch_file: "./data/custom_cid_profiles.json"
    mode: "merge"
```

---

## Expected Output Item Structure

After the pipeline completes, each item should look like this:

```json
{
  "type": "Feature",
  "stac_version": "1.0.0",
  "stac_extensions": [
    "https://raw.githubusercontent.com/DecentralizedGeo/dgeo/refs/heads/main/json-schema/schema.json"
  ],
  "id": "LC08_L1TP_001001_20210101_20210101_02_T1",
  "collection": "landsat-c2l1",
  "geometry": { "type": "Polygon", "coordinates": [[...]] },
  "bbox": [-180, -90, 180, 90],
  "properties": {
    "datetime": "2021-01-01T00:00:00Z",
    "dgeo:cids": [
      "bafybeigdyrzt5sfp7udm7hu76uh7y26nf3efuylqabf3oclgtqy55fbzdi",
      "bafybeic2zycyt36xnkbvbzqbrmhb3jndcylvqywb4zfqn7i6kcsjjl62ka"
    ],
    "dgeo:piece_cids": [
      "baga6ea4seaqao7s73y24kcutaosvacpdjgfe5pw76ooefnyqw4ynr3d2y6x2mpq"
    ],
    "dgeo:migration_date": "2026-01-28",
    "updated": "2026-01-28T12:34:56Z"
  },
  "assets": {
    "red": {
      "href": "https://example.com/red.tif",
      "title": "Red Band",
      "type": "image/tiff; application=geotiff",
      "roles": ["data"],
      "alternate": {
        "S3": {
          "href": "s3://landsat-pds/c2/l1/001/001/2021/01/01/red.tif",
          "alternate:name": "S3"
        }
      },
      "dgeo:cid": "bafybeigdyrzt5sfp7udm7hu76uh7y26nf3efuylqabf3oclgtqy55fbzdi",
      "dgeo:cid_profile": {
        "cid_version": 1,
        "hash_function": "sha2-256",
        "chunk_algorithm": "fixed",
        "chunk_size": 262144,
        "dag_layout": "balanced"
      }
    },
    "nir": {
      "href": "https://example.com/nir.tif",
      "title": "Near Infrared Band",
      "type": "image/tiff; application=geotiff",
      "roles": ["data"],
      "alternate": {
        "S3": {
          "href": "s3://landsat-pds/c2/l1/001/001/2021/01/01/nir.tif",
          "alternate:name": "S3"
        }
      },
      "dgeo:cid": "bafybeic2zycyt36xnkbvbzqbrmhb3jndcylvqywb4zfqn7i6kcsjjl62ka",
      "dgeo:cid_profile": {
        "cid_version": 1,
        "hash_function": "sha2-256",
        "chunk_algorithm": "fixed",
        "chunk_size": 262144,
        "dag_layout": "balanced"
      }
    }
  },
  "links": [
    {
      "rel": "self",
      "href": "./LC08_L1TP_001001_20210101_20210101_02_T1.json",
      "type": "application/json"
    },
    {
      "rel": "collection",
      "href": "./collection.json",
      "type": "application/json"
    }
  ]
}
```

**Key changes from original**:
- ✅ `stac_extensions` includes dgeo schema URI
- ✅ `properties.dgeo:cids` contains all item-level CIDs
- ✅ `properties.dgeo:piece_cids` contains Filecoin piece CIDs
- ✅ Each asset has `dgeo:cid` matching one of the item-level CIDs
- ✅ Each asset has `dgeo:cid_profile` with DAG metadata
- ❌ `alternate.IPFS` and `alternate.Filecoin` are removed
- ✅ `alternate.S3` is preserved (optional)

---

## Verifying the Migration

Use these commands to verify the migration results:

```bash
# 1. Check extension is declared
jq '.stac_extensions[]' outputs/*/collection-id/*.json | grep dgeo

# 2. Verify dgeo:cids array format
jq '.properties["dgeo:cids"] | type' outputs/*/collection-id/*.json | uniq
# Should output: "array"

# 3. Check CID format (CIDv1)
jq '.properties["dgeo:cids"][]' outputs/*/collection-id/*.json | head -5
# Should show CIDs starting with "bafybei..."

# 4. Verify asset-level dgeo:cid
jq '.assets | to_entries[] | select(.value["dgeo:cid"] != null) | {key: .key, cid: .value["dgeo:cid"]}' \
   outputs/*/collection-id/*.json | head -20

# 5. Check CID profile structure
jq '.assets[].["dgeo:cid_profile"]' outputs/*/collection-id/*.json | head -10

# 6. Verify old alternates are removed
jq '.assets[].alternate | keys[]' outputs/*/collection-id/*.json | grep -i "ipfs\|filecoin"
# Should return nothing (or error if no results)
```
