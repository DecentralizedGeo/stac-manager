name: landsat-dgeo-migration
description: "Migrate Landsat collection to dgeo extension, removing legacy alternates"
version: "1.0"

# Settings
settings:
  logging:
    level: DEBUG
    # file: "logs/execution.json"
    output_format: "text"
  resume_from_checkpoint: false

# Pipeline Steps
steps:
  # ============================================================================
  # STEP 1: Ingest - Fetch items from STAC API
  # ============================================================================
  - id: ingest_landsat
    module: IngestModule
    config:
      mode: api
      source: "https://stac.easierdata.info/api/v1/pgstac"
      collection_id: "landsat-c2l1"
      
      # Start with a small test set
      # max_items: 10  # Change to null for production run (all items)
      concurrency: 5
      
      # Optional: Filter by date range or bbox
      # datetime: "2023-01-01T00:00:00Z/.."
      # bbox: [-180, -90, 180, 90]

  # ============================================================================
  # STEP 2: Update - Remove legacy IPFS/Filecoin alternate assets
  # ============================================================================
  - id: remove_old_alternates
    module: UpdateModule
    depends_on: [ingest_landsat]
    config:
      # Remove the alternate asset objects containing IPFS and Filecoin
      # Wildcards (*) match all asset keys
      removes:
        - "assets.*.alternate.IPFS"
        - "assets.*.alternate.Filecoin"
        # Keep S3 alternates if present
        - "assets.*.alternate.S3"  # Uncomment to remove S3 too

  # ============================================================================
  # STEP 3: Extension - Add dgeo extension scaffolding
  # ============================================================================
  - id: add_dgeo_extension
    module: ExtensionModule
    depends_on: [remove_old_alternates]
    config:
      # dgeo extension schema
      schema_uri: "https://raw.githubusercontent.com/DecentralizedGeo/dgeo/refs/heads/main/json-schema/schema.json"
      
      # Include only required fields (prevent None values for optional fields)
      required_fields_only: true
      
      # Set default values
      defaults:
        # Properties-level fields (will be populated by TransformModule)
        # properties.dgeo:cids: []
        # properties.dgeo:piece_cids: []
        
        # Asset-level CID profile defaults (applied to all assets via wildcard)
        assets.*.dgeo:cid_profile.cid_version: 1
        assets.*.dgeo:cid_profile.hash_function: "sha2-256"
        assets.*.dgeo:cid_profile.chunk_algorithm: "fixed"
        assets.*.dgeo:cid_profile.chunk_size: 262144
        assets.*.dgeo:cid_profile.dag_layout: "balanced"

  # ============================================================================
  # STEP 4: Transform - Enrich with extracted asset metadata
  # ============================================================================
  - id: enrich_with_metadata
    module: TransformModule
    depends_on: [add_dgeo_extension]
    config:
      # JSON file generated by: extract_assets_for_dgeo.py convert
      input_file: "./data/landsat/landsat_assets_metadata.json"
      
      # Join on item ID
      input_join_key: "id"
      
      # Merge strategy: keep existing fields, add new ones
      strategy: "merge"
      
      # Log warnings for items missing in metadata file
      handle_missing: "warn"
      
      # Field mapping: source field -> target field in item.properties
      field_mapping:
        # Map extracted CID arrays to dgeo properties
        properties.dgeo:cids: "ipfs_cids"
        properties.dgeo:piece_cids: "filecoin_piece_cids"

  # ============================================================================
  # STEP 5: Transform - Set asset alternates from full metadata
  # ============================================================================
  - id: set_asset_cids
    module: TransformModule
    depends_on: [enrich_with_metadata]
    config:
      # JSON file with full asset metadata (including alternates)
      input_file: "./data/landsat/landsat_assets_full.json"
      
      # Join on item ID
      input_join_key: "item_id"
      
      # Merge strategy: keep existing fields, add new ones (merges dictionaries)
      strategy: "merge"
      
      # Log warnings for items missing in metadata file
      handle_missing: "warn"
      
      # Field mapping: source field (JMESPath) -> target field (dot notation)
      field_mapping:
        # Band Assets
        assets.blue.alternate: "assets.blue.alternates"
        assets.blue.href: "assets.blue.alternates.ipfs.href"
        assets.blue.type: "assets.blue.alternates.ipfs.type"
        
        assets.cirrus.alternate: "assets.cirrus.alternates"
        assets.cirrus.href: "assets.cirrus.alternates.ipfs.href"
        assets.cirrus.type: "assets.cirrus.alternates.ipfs.type"
        
        assets.coastal.alternate: "assets.coastal.alternates"
        assets.coastal.href: "assets.coastal.alternates.ipfs.href"
        assets.coastal.type: "assets.coastal.alternates.ipfs.type"
        
        assets.green.alternate: "assets.green.alternates"
        assets.green.href: "assets.green.alternates.ipfs.href"
        assets.green.type: "assets.green.alternates.ipfs.type"
        
        assets.lwir11.alternate: "assets.lwir11.alternates"
        assets.lwir11.href: "assets.lwir11.alternates.ipfs.href"
        assets.lwir11.type: "assets.lwir11.alternates.ipfs.type"
        
        assets.lwir12.alternate: "assets.lwir12.alternates"
        assets.lwir12.href: "assets.lwir12.alternates.ipfs.href"
        assets.lwir12.type: "assets.lwir12.alternates.ipfs.type"
        
        assets.nir08.alternate: "assets.nir08.alternates"
        assets.nir08.href: "assets.nir08.alternates.ipfs.href"
        assets.nir08.type: "assets.nir08.alternates.ipfs.type"
        
        assets.pan.alternate: "assets.pan.alternates"
        assets.pan.href: "assets.pan.alternates.ipfs.href"
        assets.pan.type: "assets.pan.alternates.ipfs.type"
        
        assets.qa_pixel.alternate: "assets.qa_pixel.alternates"
        assets.qa_pixel.href: "assets.qa_pixel.alternates.ipfs.href"
        assets.qa_pixel.type: "assets.qa_pixel.alternates.ipfs.type"
        
        assets.qa_radsat.alternate: "assets.qa_radsat.alternates"
        assets.qa_radsat.href: "assets.qa_radsat.alternates.ipfs.href"
        assets.qa_radsat.type: "assets.qa_radsat.alternates.ipfs.type"
        
        assets.red.alternate: "assets.red.alternates"
        assets.red.href: "assets.red.alternates.ipfs.href"
        assets.red.type: "assets.red.alternates.ipfs.type"
        
        assets.SAA.alternate: "assets.SAA.alternates"
        assets.SAA.href: "assets.SAA.alternates.ipfs.href"
        assets.SAA.type: "assets.SAA.alternates.ipfs.type"
        
        assets.swir16.alternate: "assets.swir16.alternates"
        assets.swir16.href: "assets.swir16.alternates.ipfs.href"
        assets.swir16.type: "assets.swir16.alternates.ipfs.type"
        
        assets.swir22.alternate: "assets.swir22.alternates"
        assets.swir22.href: "assets.swir22.alternates.ipfs.href"
        assets.swir22.type: "assets.swir22.alternates.ipfs.type"
        
        assets.SZA.alternate: "assets.SZA.alternates"
        assets.SZA.href: "assets.SZA.alternates.ipfs.href"
        assets.SZA.type: "assets.SZA.alternates.ipfs.type"
        
        assets.VAA.alternate: "assets.VAA.alternates"
        assets.VAA.href: "assets.VAA.alternates.ipfs.href"
        assets.VAA.type: "assets.VAA.alternates.ipfs.type"
        
        assets.VZA.alternate: "assets.VZA.alternates"
        assets.VZA.href: "assets.VZA.alternates.ipfs.href"
        assets.VZA.type: "assets.VZA.alternates.ipfs.type"
        
        # Metadata Assets (keys with dots need quoting in JMESPath source)
        'assets."ANG.txt".alternate': "assets.\"ANG.txt\".alternates"
        'assets."ANG.txt".href': "assets.\"ANG.txt\".alternates.ipfs.href"
        'assets."ANG.txt".type': "assets.\"ANG.txt\".alternates.ipfs.type"
        
        'assets."MTL.json".alternate': "assets.\"MTL.json\".alternates"
        'assets."MTL.json".href': "assets.\"MTL.json\".alternates.ipfs.href"
        'assets."MTL.json".type': "assets.\"MTL.json\".alternates.ipfs.type"
        
        'assets."MTL.txt".alternate': "assets.\"MTL.txt\".alternates"
        'assets."MTL.txt".href': "assets.\"MTL.txt\".alternates.ipfs.href"
        'assets."MTL.txt".type': "assets.\"MTL.txt\".alternates.ipfs.type"
        
        'assets."MTL.xml".alternate': "assets.\"MTL.xml\".alternates"
        'assets."MTL.xml".href': "assets.\"MTL.xml\".alternates.ipfs.href"
        'assets."MTL.xml".type': "assets.\"MTL.xml\".alternates.ipfs.type"
        
        # Browse/Index Assets
        assets.index.alternate: "assets.index.alternates"
        assets.index.href: "assets.index.alternates.ipfs.href"
        assets.index.type: "assets.index.alternates.ipfs.type"
        
        assets.reduced_resolution_browse.alternate: "assets.reduced_resolution_browse.alternates"
        assets.reduced_resolution_browse.href: "assets.reduced_resolution_browse.alternates.ipfs.href"
        assets.reduced_resolution_browse.type: "assets.reduced_resolution_browse.alternates.ipfs.type"
        
        assets.thumbnail.alternate: "assets.thumbnail.alternates"
        assets.thumbnail.href: "assets.thumbnail.alternates.ipfs.href"
        assets.thumbnail.type: "assets.thumbnail.alternates.ipfs.type"

  # ============================================================================
  # STEP 6: Update - Set final defaults and timestamps
  # ============================================================================
  - id: set_final_defaults
    module: UpdateModule
    depends_on: [set_asset_cids]
    config:
      # Optional: Set any additional metadata
      updates:
        # Example: Track migration date
        # properties.dgeo:migration_date: "2026-01-28"
        
        # Example: Add custom metadata
        # properties.processing_version: "dgeo-migration-v1"
      
      # Automatically update the 'updated' timestamp
      auto_update_timestamp: true

  # ============================================================================
  # STEP 7: Validate - Check STAC compliance
  # ============================================================================
  # - id: validate_items
  #   module: ValidateModule
  #   depends_on: [set_final_defaults]
  #   config:
  #     # Permissive mode: log warnings but don't fail the pipeline
  #     strict: false
      
  #     # The dgeo extension will be automatically validated
  #     # since it's in the item's stac_extensions array

  # ============================================================================
  # STEP 8: Output - Save migrated items to JSON
  # ============================================================================
  - id: output_json
    module: OutputModule
    depends_on: [set_final_defaults]
    config:
      # Output directory
      base_dir: "./outputs/landsat-dgeo-migrated"
      
      # Format: json (individual files) or parquet (single file)
      format: "json"
      
      # Organization: 'collection' (folder per collection) or 'flat' (all in one folder)
      organize_by: "collection"
      
      # Generate a collection.json file
      include_collection: true
      
      # Optional: Set base URL for self links
      # base_url: "https://stac.easierdata.info/api/v1/pgstac"

# ============================================================================
# Post-Pipeline Notes
# ============================================================================
# After running this workflow:
# 
# 1. Review outputs:
#    ls -lh outputs/landsat-dgeo-migrated/landsat-c2l1/
# 
# 2. Verify a sample item:
#    jq '.' outputs/landsat-dgeo-migrated/landsat-c2l1/LC08_L1TP_*.json | head -100
# 
# 3. Check for dgeo extension:
#    jq '.stac_extensions' outputs/landsat-dgeo-migrated/landsat-c2l1/*.json | grep dgeo
# 
# 4. Verify dgeo:cids:
#    jq '.properties["dgeo:cids"]' outputs/landsat-dgeo-migrated/landsat-c2l1/*.json | head
# 
# 5. Check asset-level dgeo:cid:
#    jq '.assets[] | select(.["dgeo:cid"] != null) | .["dgeo:cid"]' \
#       outputs/landsat-dgeo-migrated/landsat-c2l1/*.json | head
# 
# 6. If successful with test set, update max_items to null and re-run for full migration
