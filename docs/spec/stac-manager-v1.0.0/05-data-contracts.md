# Data & System Contracts
## STAC Manager v1.0

**Related Documents**:
- [Protocols](./06-protocols.md)
- [Pipeline Management](./01-pipeline-management.md)

---

This document defines the strict data structures and contracts used for inter-module communication, ensuring type safety and memory efficiency.

## 1. Streaming vs Batching (Role-Based)

To support large-scale catalogs (1M+ items), the pipeline **MUST** use Iterators/Generators to maintain a constant memory profile.

- **Wire Format (The Pipe)**: `AsyncIterator[dict]`
- **Module Internal Logic**: `pystac.Item` or `pystac.Collection`

### Rationale: Why `dict` for inter-module transfer?
1.  **Performance**: Avoids redundant serialization/deserialization cycles between every step in the pipeline.
2.  **Stability**: Pass-through data (fields not used by a specific module) remains untouched and safe from library-version-specific parsing quirks.
3.  **Flexibility**: Allows non-STAC or "Dirty" metadata (from Transform modules) to flow through the same pipeline structure before being scaffolded.

**Requirement**: Item-processing modules **MUST NOT** accumulate entire streams into `list[dict]` in-memory.

---

## 2. Intermediate Data Schema

The contract between `TransformModule` and `ScaffoldModule`.

```python
from typing import TypedDict, Any

class TransformedItem(TypedDict, total=False):
    """
    Standardized dictionary output from TransformModule.
    Does not strictly require valid STAC fields yet, but MUST possess structure.
    """
    id: str                             # Required: Item identifier
    geometry: dict | None               # GeoJSON geometry or None
    bbox: list[float] | None            # Bounding box [minx, miny, maxx, maxy]
    datetime: str | None                # ISO 8601 datetime string
    properties: dict[str, Any]          # Additional properties
    assets: dict[str, dict]             # Asset definitions (key -> asset dict)
    links: list[dict] | None            # Optional link objects
```

**Usage**: See [Protocols](./06-protocols.md#31-transformeditem) for full specification.

---

## 3. Failure Report Schema

The schema of the `failures.json` file generated at workflow end.

### 3.1 Complete Schema

```json
{
  "workflow_name": "string",
  "workflow_id": "uuid-string (optional)",
  "started_at": "iso-timestamp",
  "ended_at": "iso-timestamp",
  "total_steps": 5,
  "total_failures": 12,
  "failures_by_step": {
    "ingest": 8,
    "transform": 3,
    "validate": 1
  },
  "failures": [
    {
      "step_id": "transform",
      "item_id": "item-abc-123",
      "error_type": "ValidationError",
      "message": "Missing required field 'datetime'",
      "timestamp": "2024-01-15T12:30:45Z",
      "context": {
        "source_file": "data/modis.csv",
        "line_number": 45,
        "field_name": "datetime"
      }
    }
  ]
}
```

### 3.2 Field Descriptions

| Field | Type | Description |
|-------|------|-------------|
| `workflow_name` | string | Workflow name from config |
| `workflow_id` | string? | Optional UUID for workflow run |
| `started_at` | string | ISO 8601 timestamp of workflow start |
| `ended_at` | string | ISO 8601 timestamp of workflow completion |
| `total_steps` | integer | Total number of workflow steps |
| `total_failures` | integer | Total number of item-level failures |
| `failures_by_step` | dict | Failure counts grouped by step_id |
| `failures` | array | Detailed failure records |

### 3.3 Failure Record Fields

| Field | Type | Description |
|-------|------|-------------|
| `step_id` | string | Step where failure occurred |
| `item_id` | string | Item identifier (or "unknown") |
| `error_type` | string | Exception class name or category |
| `message` | string | Human-readable error description |
| `timestamp` | string | ISO 8601 timestamp of failure |
| `context` | object? | Optional additional debugging info |

### 3.4 Context Object (Optional)

The `context` field may contain step-specific debugging information:

```json
{
  "source_file": "data/input.csv",
  "line_number": 123,
  "field_name": "geometry",
  "url": "https://api.example.com/items/abc",
  "http_status": 429,
  "retry_attempt": 3
}
```

---

## 4. Output Manifest Schema

The output manifest is generated by the `OutputModule` to document what files were written.

### 4.1 Complete Schema

```json
{
  "workflow_name": "nasa_earth_catalog",
  "timestamp": "2024-01-15T12:30:00Z",
  "format": "parquet",
  "organize_by": "item_id",
  "output_path": "./output/cmr-stac",
  "files": [
    {
      "path": "output/collection_A.parquet",
      "collection_id": "MODIS_Terra_L3",
      "item_count": 5432,
      "size_bytes": 12456789,
      "created_at": "2024-01-15T12:28:30Z"
    },
    {
      "path": "output/collection_B.parquet",
      "collection_id": "SENTINEL_1A",
      "item_count": 8921,
      "size_bytes": 23456789,
      "created_at": "2024-01-15T12:29:15Z"
    }
  ],
  "total_items": 14353,
  "total_size_bytes": 35913578,
  "total_files": 2
}
```

### 4.2 Field Descriptions

| Field | Type | Description |
|-------|------|-------------|
| `workflow_name` | string | Workflow name from config |
| `timestamp` | string | ISO 8601 timestamp of manifest creation |
| `format` | string | Output format ("json" or "parquet") |
| `organize_by` | string | Organization strategy ("item_id", "flat", "collection") |
| `output_path` | string | Root output directory |
| `files` | array | List of files written |
| `total_items` | integer | Total STAC items written |
| `total_size_bytes` | integer | Total size of all output files |
| `total_files` | integer | Total number of files written |

### 4.3 File Record Fields

| Field | Type | Description |
|-------|------|-------------|
| `path` | string | Relative or absolute path to file |
| `collection_id` | string? | Collection ID (if organized by collection) |
| `item_count` | integer | Number of items in this file |
| `size_bytes` | integer | File size in bytes |
| `created_at` | string | ISO 8601 timestamp of file creation |

### 4.4 Usage

The manifest enables downstream processing:

```python
# Ingest into pgstac
import json
with open('output/manifest.json') as f:
    manifest = json.load(f)

for file_record in manifest['files']:
    ingest_to_pgstac(file_record['path'])
```

---

## 5. Query Language Standard

For all configuration fields involving field selection or mapping (e.g., `TransformModule` schemas, filtering logic):

- **Standard**: [JMESPath](https://jmespath.org/)
- **Library**: `jmespath` (Python)
- **Rationale**: Standard, robust, security-safe (no `eval`)

**Example**: Transform schema using JMESPath  

```yaml
mappings:
  - source_field: "metadata.acquisition.datetime"
    target_field: "properties.datetime"
    type: datetime
```

---

## 6. Output Result Schema

Result structure returned by `OutputModule.finalize()`:

```python
from typing import TypedDict

class OutputResult(TypedDict):
    """
    Result returned by OutputModule.finalize().
    
    Provides information about files written during output.
    """
    files_written: list[str]    # Absolute paths to written files
    manifest_path: str          # Path to manifest.json
    manifest: dict              # Full manifest content (see Section 4)
```

---

## 7. Workflow Result Schema

Result structure returned by `StacManager.execute()`:

```python
from typing import TypedDict, Literal

class WorkflowResult(TypedDict):
    """
    Result of a complete workflow execution.
    """
    success: bool                                              # Overall success (no critical crashes)
    status: Literal['completed', 'completed_with_failures', 'failed']
    summary: str                                               # Human-readable summary
    failure_count: int                                         # Total item-level failures
    failures_path: str | None                                  # Path to failures.json (if any)
```

---

## 8. Summary

This document defines:

1. **Streaming Requirement**: Use `AsyncIterator` not `list` for items
2. **TransformedItem**: Contract between Transform and Scaffold modules
3. **Failure Report**: Complete schema for error tracking
4. **Output Manifest**: Complete schema for documenting written files
5. **Query Language**: JMESPath for field mapping
6. **OutputResult**: Return type for OutputModule.finalize()
7. **WorkflowResult**: Return type for StacManager.execute()

These contracts ensure type safety and enable large-scale processing.

