# Extension Module
## STAC Manager v1.0

**Role**: `Modifier` (Processor)

---

## 1. Purpose
Applies STAC extensions to **Items or Collections**. It uses a pluggable architecture to support both built-in extensions (like `dgeo`) and custom user-provided extensions.

## 2. Architecture
The module follows a registry-based strategy to allow both strict built-ins and flexible custom code.
- **Built-in**: Refereed by short-name (e.g., `dgeo`).
- **Custom**: Referenced by absolute Python import path (e.g., `my_lib.extensions.MyExt`).
  - *Requirement*: The package must be importable in the current environment (pip installed or PYTHONPATH).

### 2.1 ExtensionRegistry
- **Responsibility**: Maintains a mapping of short-names (e.g. `dgeo`) to Python module paths.
- **Bootstrapping**: Pre-loaded with standard supported extensions.

### 2.2 ExtensionLoader
- **Responsibility**: Dynamically imports Python modules and verifies they implement the `Extension` Protocol.
- **Caching**: Caches loaded extension classes for performance.

### 2.3 ExtensionApplicator
- **Responsibility**: The worker that actually modifies the item.
- **Logic**:
    1. Checks if extension schema URI is in `stac_extensions`.
    2. Calls `extension.apply()`.
    3. Calls `extension.validate()` (if configured).

### 2.4 Pipe Interop (Dict <-> Item)
The `ExtensionModule` implements the synchronous `Modifier` protocol:
- **Input**: Raw `dict`.
- **Process**: Internal conversion to `pystac.Item` using `pystac.Item.from_dict()`.
- **Apply**: Applies the plugin's `Extension.apply()` logic.
- **Output**: Returns the object back to the pipe via `item.to_dict()`.

## 3. Configuration Schema

```python
from pydantic import BaseModel, Field
from typing import Dict, Any

class ExtensionConfig(BaseModel):
    extension: str # Built-in name OR python path
    config: Dict[str, Any] = Field(default_factory=dict) # Extension-specific config
    validate: bool = False # Whether to run validation after application
```

### 3.1 Example Usage (YAML)

```yaml
- id: apply_dgeo
  module: ExtensionModule
  config:
    extension: "dgeo"
    config:
      ownership:
        did: "did:key:z6Mk..."
        type: "individual"
      licensing:
        license: "CC-BY-4.0"
```

## 4. I/O Contract

**Input (Workflow Context)**:
- Items from previous step.

**Output (Python)**:
```python
def modify(self, item: dict, context: WorkflowContext) -> dict | None:
    """
    Applies STAC extensions to the item dictionary.
    """
```

## 5. Built-in Extensions
### dgeo
- **Schema**: DecentralizedGeo Asset schema.
- **Fields**: `dgeo:ownership`, `dgeo:provenance`.

### alternate-assets
- **Schema**: Alternate Assets extension.
- **Fields**: `alternate`: { "s3": ... } in assets.

## 6. Error Handling
- **Load Error**: Fail fast if extension module cannot be found.
- **Apply Error**: Log warning and skip Item if extension logic fails.
- **Validation Error**: Generated by the extension's `validate()` method; leads to item rejection.
